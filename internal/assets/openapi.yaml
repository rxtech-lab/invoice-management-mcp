openapi: 3.0.3
info:
  title: Invoice Management API
  description: API for managing invoices, categories, companies, and file uploads
  version: 1.0.0
  contact:
    name: RxTech Lab
    url: https://github.com/rxtech-lab/invoice-management

servers:
  - url: /api
    description: API server

tags:
  - name: Categories
    description: Invoice category management
  - name: Companies
    description: Company/vendor management
  - name: Receivers
    description: Invoice receiver management
  - name: Tags
    description: Invoice tag management
  - name: Invoices
    description: Invoice management
  - name: Invoice Items
    description: Invoice line items
  - name: Upload
    description: File upload operations
  - name: Health
    description: Health check endpoints
  - name: Analytics
    description: Invoice analytics and reporting

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns the health status of the service
      operationId: healthCheck
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /api/categories:
    get:
      tags:
        - Categories
      summary: List categories
      description: Returns a paginated list of categories with optional search
      operationId: listCategories
      parameters:
        - name: keyword
          in: query
          description: Search keyword for category name
          schema:
            type: string
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: List of categories
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategoryListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - Categories
      summary: Create category
      description: Creates a new invoice category
      operationId: createCategory
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCategoryRequest'
      responses:
        '201':
          description: Category created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Category'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/categories/{id}:
    get:
      tags:
        - Categories
      summary: Get category
      description: Returns a category by ID
      operationId: getCategory
      parameters:
        - $ref: '#/components/parameters/CategoryId'
      responses:
        '200':
          description: Category details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Category'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    put:
      tags:
        - Categories
      summary: Update category
      description: Updates an existing category
      operationId: updateCategory
      parameters:
        - $ref: '#/components/parameters/CategoryId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCategoryRequest'
      responses:
        '200':
          description: Category updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Category'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

    delete:
      tags:
        - Categories
      summary: Delete category
      description: Deletes a category
      operationId: deleteCategory
      parameters:
        - $ref: '#/components/parameters/CategoryId'
      responses:
        '204':
          description: Category deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/companies:
    get:
      tags:
        - Companies
      summary: List companies
      description: Returns a paginated list of companies with optional search
      operationId: listCompanies
      parameters:
        - name: keyword
          in: query
          description: Search keyword for company name
          schema:
            type: string
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: List of companies
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CompanyListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - Companies
      summary: Create company
      description: Creates a new company/vendor
      operationId: createCompany
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCompanyRequest'
      responses:
        '201':
          description: Company created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Company'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/companies/{id}:
    get:
      tags:
        - Companies
      summary: Get company
      description: Returns a company by ID
      operationId: getCompany
      parameters:
        - $ref: '#/components/parameters/CompanyId'
      responses:
        '200':
          description: Company details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Company'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    put:
      tags:
        - Companies
      summary: Update company
      description: Updates an existing company
      operationId: updateCompany
      parameters:
        - $ref: '#/components/parameters/CompanyId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCompanyRequest'
      responses:
        '200':
          description: Company updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Company'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

    delete:
      tags:
        - Companies
      summary: Delete company
      description: Deletes a company
      operationId: deleteCompany
      parameters:
        - $ref: '#/components/parameters/CompanyId'
      responses:
        '204':
          description: Company deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/receivers:
    get:
      tags:
        - Receivers
      summary: List receivers
      description: Returns a paginated list of receivers with optional search
      operationId: listReceivers
      parameters:
        - name: keyword
          in: query
          description: Search keyword for receiver name
          schema:
            type: string
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: List of receivers
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReceiverListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - Receivers
      summary: Create receiver
      description: Creates a new invoice receiver
      operationId: createReceiver
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateReceiverRequest'
      responses:
        '201':
          description: Receiver created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Receiver'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/receivers/{id}:
    get:
      tags:
        - Receivers
      summary: Get receiver
      description: Returns a receiver by ID
      operationId: getReceiver
      parameters:
        - $ref: '#/components/parameters/ReceiverId'
      responses:
        '200':
          description: Receiver details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Receiver'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    put:
      tags:
        - Receivers
      summary: Update receiver
      description: Updates an existing receiver
      operationId: updateReceiver
      parameters:
        - $ref: '#/components/parameters/ReceiverId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateReceiverRequest'
      responses:
        '200':
          description: Receiver updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Receiver'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

    delete:
      tags:
        - Receivers
      summary: Delete receiver
      description: Deletes a receiver
      operationId: deleteReceiver
      parameters:
        - $ref: '#/components/parameters/ReceiverId'
      responses:
        '204':
          description: Receiver deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/receivers/merge:
    post:
      tags:
        - Receivers
      summary: Merge receivers
      description: Merge multiple receivers into one. All invoices from source receivers will be reassigned to the target receiver.
      operationId: mergeReceivers
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MergeReceiversRequest'
      responses:
        '200':
          description: Receivers merged successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MergeReceiversResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/tags:
    get:
      tags:
        - Tags
      summary: List tags
      description: Returns a paginated list of tags with optional search
      operationId: listTags
      parameters:
        - name: keyword
          in: query
          description: Search keyword for tag name
          schema:
            type: string
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: List of tags
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TagListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - Tags
      summary: Create tag
      description: Creates a new invoice tag
      operationId: createTag
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTagRequest'
      responses:
        '201':
          description: Tag created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tag'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/tags/{id}:
    get:
      tags:
        - Tags
      summary: Get tag
      description: Returns a tag by ID
      operationId: getTag
      parameters:
        - $ref: '#/components/parameters/TagId'
      responses:
        '200':
          description: Tag details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tag'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    put:
      tags:
        - Tags
      summary: Update tag
      description: Updates an existing tag
      operationId: updateTag
      parameters:
        - $ref: '#/components/parameters/TagId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTagRequest'
      responses:
        '200':
          description: Tag updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tag'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

    delete:
      tags:
        - Tags
      summary: Delete tag
      description: Deletes a tag and removes it from all invoices
      operationId: deleteTag
      parameters:
        - $ref: '#/components/parameters/TagId'
      responses:
        '204':
          description: Tag deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/invoices/{id}/tags:
    post:
      tags:
        - Tags
      summary: Add tag to invoice
      description: Adds a tag to an invoice
      operationId: addTagToInvoice
      parameters:
        - $ref: '#/components/parameters/InvoiceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - tag_id
              properties:
                tag_id:
                  type: integer
                  description: Tag ID to add
      responses:
        '200':
          description: Tag added to invoice
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Invoice'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/invoices/{id}/tags/{tagId}:
    delete:
      tags:
        - Tags
      summary: Remove tag from invoice
      description: Removes a tag from an invoice
      operationId: removeTagFromInvoice
      parameters:
        - $ref: '#/components/parameters/InvoiceId'
        - name: tagId
          in: path
          required: true
          description: Tag ID to remove
          schema:
            type: integer
      responses:
        '200':
          description: Tag removed from invoice
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Invoice'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/invoices:
    get:
      tags:
        - Invoices
      summary: List invoices
      description: Returns a paginated list of invoices with filtering and sorting
      operationId: listInvoices
      parameters:
        - name: keyword
          in: query
          description: Search keyword for invoice title or description
          schema:
            type: string
        - name: category_id
          in: query
          description: Filter by category ID
          schema:
            type: integer
        - name: company_id
          in: query
          description: Filter by company ID
          schema:
            type: integer
        - name: receiver_id
          in: query
          description: Filter by receiver ID
          schema:
            type: integer
        - name: tag_ids
          in: query
          description: Filter by tag IDs (comma-separated)
          schema:
            type: string
          example: "1,2,3"
        - name: status
          in: query
          description: Filter by invoice status
          schema:
            $ref: '#/components/schemas/InvoiceStatus'
        - name: sort_by
          in: query
          description: Field to sort by
          schema:
            type: string
            enum: [created_at, updated_at, amount, due_date, title]
            default: created_at
        - name: sort_order
          in: query
          description: Sort order
          schema:
            type: string
            enum: [asc, desc]
            default: desc
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Offset'
      responses:
        '200':
          description: List of invoices
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoiceListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - Invoices
      summary: Create invoice
      description: Creates a new invoice with optional line items
      operationId: createInvoice
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateInvoiceRequest'
      responses:
        '201':
          description: Invoice created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Invoice'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/invoices/{id}:
    get:
      tags:
        - Invoices
      summary: Get invoice
      description: Returns an invoice by ID including items
      operationId: getInvoice
      parameters:
        - $ref: '#/components/parameters/InvoiceId'
      responses:
        '200':
          description: Invoice details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Invoice'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    put:
      tags:
        - Invoices
      summary: Update invoice
      description: Updates an existing invoice
      operationId: updateInvoice
      parameters:
        - $ref: '#/components/parameters/InvoiceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateInvoiceRequest'
      responses:
        '200':
          description: Invoice updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Invoice'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

    delete:
      tags:
        - Invoices
      summary: Delete invoice
      description: Deletes an invoice and its items
      operationId: deleteInvoice
      parameters:
        - $ref: '#/components/parameters/InvoiceId'
      responses:
        '204':
          description: Invoice deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/invoices/{id}/status:
    patch:
      tags:
        - Invoices
      summary: Update invoice status
      description: Updates only the status of an invoice
      operationId: updateInvoiceStatus
      parameters:
        - $ref: '#/components/parameters/InvoiceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateStatusRequest'
      responses:
        '200':
          description: Invoice status updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Invoice'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/invoices/{id}/items:
    post:
      tags:
        - Invoice Items
      summary: Add invoice item
      description: Adds a line item to an invoice
      operationId: addInvoiceItem
      parameters:
        - $ref: '#/components/parameters/InvoiceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddItemRequest'
      responses:
        '201':
          description: Item added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoiceItem'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/invoices/{invoice_id}/items/{item_id}:
    put:
      tags:
        - Invoice Items
      summary: Update invoice item
      description: Updates a line item in an invoice
      operationId: updateInvoiceItem
      parameters:
        - name: invoice_id
          in: path
          required: true
          description: Invoice ID
          schema:
            type: integer
        - name: item_id
          in: path
          required: true
          description: Item ID
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateItemRequest'
      responses:
        '200':
          description: Item updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoiceItem'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

    delete:
      tags:
        - Invoice Items
      summary: Delete invoice item
      description: Deletes a line item from an invoice
      operationId: deleteInvoiceItem
      parameters:
        - name: invoice_id
          in: path
          required: true
          description: Invoice ID
          schema:
            type: integer
        - name: item_id
          in: path
          required: true
          description: Item ID
          schema:
            type: integer
      responses:
        '204':
          description: Item deleted
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/upload:
    post:
      tags:
        - Upload
      summary: Upload file
      description: Uploads a file to S3-compatible storage
      operationId: uploadFile
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: File to upload
      responses:
        '201':
          description: File uploaded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/upload/presigned:
    get:
      tags:
        - Upload
      summary: Get presigned upload URL
      description: Generates a presigned URL for direct upload to S3
      operationId: getPresignedURL
      parameters:
        - name: filename
          in: query
          required: true
          description: Name of the file to upload
          schema:
            type: string
        - name: content_type
          in: query
          description: MIME type of the file
          schema:
            type: string
            default: application/octet-stream
      responses:
        '200':
          description: Presigned URL generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PresignedURLResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/upload/html-to-pdf:
    post:
      tags:
        - Upload
      summary: Convert HTML to PDF and upload
      description: Accepts HTML content, sanitizes it, converts to PDF using headless Chrome, and uploads to S3-compatible storage
      operationId: uploadHtmlToPdf
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HtmlToPdfRequest'
      responses:
        '201':
          description: PDF generated and uploaded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          description: PDF conversion failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/files/{key}/download:
    get:
      tags:
        - Upload
      summary: Get file download URL
      description: Generates a presigned download URL for a file. Only the file owner can access this.
      operationId: getFileDownloadURL
      parameters:
        - name: key
          in: path
          required: true
          description: S3 object key of the file
          schema:
            type: string
      responses:
        '200':
          description: Download URL generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileDownloadURLResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Forbidden - user does not own this file
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/analytics/summary:
    get:
      tags:
        - Analytics
      summary: Get invoice summary analytics
      description: Returns total, paid, and unpaid invoice amounts for a time period
      operationId: getAnalyticsSummary
      parameters:
        - name: period
          in: query
          description: Time period for analytics
          schema:
            type: string
            enum: [7d, 1m, 1y]
            default: 1m
      responses:
        '200':
          description: Analytics summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalyticsSummary'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/analytics/by-category:
    get:
      tags:
        - Analytics
      summary: Get invoice analytics grouped by category
      description: Returns invoice amounts grouped by category for a time period
      operationId: getAnalyticsByCategory
      parameters:
        - name: period
          in: query
          description: Time period for analytics
          schema:
            type: string
            enum: [7d, 1m, 1y]
            default: 1m
      responses:
        '200':
          description: Analytics by category
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalyticsByGroup'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/analytics/by-company:
    get:
      tags:
        - Analytics
      summary: Get invoice analytics grouped by company
      description: Returns invoice amounts grouped by company for a time period
      operationId: getAnalyticsByCompany
      parameters:
        - name: period
          in: query
          description: Time period for analytics
          schema:
            type: string
            enum: [7d, 1m, 1y]
            default: 1m
      responses:
        '200':
          description: Analytics by company
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalyticsByGroup'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/analytics/by-receiver:
    get:
      tags:
        - Analytics
      summary: Get invoice analytics grouped by receiver
      description: Returns invoice amounts grouped by receiver for a time period
      operationId: getAnalyticsByReceiver
      parameters:
        - name: period
          in: query
          description: Time period for analytics
          schema:
            type: string
            enum: [7d, 1m, 1y]
            default: 1m
      responses:
        '200':
          description: Analytics by receiver
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalyticsByGroup'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/analytics/by-tag:
    get:
      tags:
        - Analytics
      summary: Get invoice analytics grouped by tag
      description: Returns invoice amounts grouped by tag for a time period
      operationId: getAnalyticsByTag
      parameters:
        - name: period
          in: query
          description: Time period for analytics
          schema:
            type: string
            enum: [7d, 1m, 1y]
            default: 1m
      responses:
        '200':
          description: Analytics by tag
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalyticsByGroup'
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT Bearer token authentication.

        Obtain a JWT token from your OAuth/OIDC provider and include it in the
        Authorization header as: `Authorization: Bearer <token>`

        The JWT must:
        - Be signed with RS256, RS384, RS512, ES256, ES384, or ES512
        - Have a valid `sub` (subject) claim identifying the user
        - Not be expired

        Optional claims:
        - `roles` or `role`: User roles for authorization
        - `scope` or `scp`: OAuth scopes

    OAuth2:
      type: oauth2
      description: OAuth 2.0 authentication flow
      flows:
        authorizationCode:
          authorizationUrl: https://auth.example.com/authorize
          tokenUrl: https://auth.example.com/token
          scopes:
            read:invoices: Read invoices
            write:invoices: Create, update, delete invoices
            read:categories: Read categories
            write:categories: Create, update, delete categories
            read:companies: Read companies
            write:companies: Create, update, delete companies
            read:receivers: Read receivers
            write:receivers: Create, update, delete receivers

  parameters:
    CategoryId:
      name: id
      in: path
      required: true
      description: Category ID
      schema:
        type: integer

    CompanyId:
      name: id
      in: path
      required: true
      description: Company ID
      schema:
        type: integer

    ReceiverId:
      name: id
      in: path
      required: true
      description: Receiver ID
      schema:
        type: integer

    TagId:
      name: id
      in: path
      required: true
      description: Tag ID
      schema:
        type: integer

    InvoiceId:
      name: id
      in: path
      required: true
      description: Invoice ID
      schema:
        type: integer

    Limit:
      name: limit
      in: query
      description: Maximum number of items to return
      schema:
        type: integer
        default: 50
        minimum: 1
        maximum: 100

    Offset:
      name: offset
      in: query
      description: Number of items to skip
      schema:
        type: integer
        default: 0
        minimum: 0

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message

    Category:
      type: object
      properties:
        id:
          type: integer
          description: Category ID
        user_id:
          type: string
          description: Owner user ID
        name:
          type: string
          description: Category name
        description:
          type: string
          description: Category description
        color:
          type: string
          description: Hex color code (e.g., #FF5733)
          pattern: '^#[0-9A-Fa-f]{6}$'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateCategoryRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: Category name
        description:
          type: string
          description: Category description
        color:
          type: string
          description: Hex color code

    UpdateCategoryRequest:
      type: object
      properties:
        name:
          type: string
          description: Category name
        description:
          type: string
          description: Category description
        color:
          type: string
          description: Hex color code

    CategoryListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Category'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    Company:
      type: object
      properties:
        id:
          type: integer
          description: Company ID
        user_id:
          type: string
          description: Owner user ID
        name:
          type: string
          description: Company name
        address:
          type: string
          description: Company address
        email:
          type: string
          format: email
          description: Contact email
        phone:
          type: string
          description: Contact phone
        website:
          type: string
          format: uri
          description: Company website
        tax_id:
          type: string
          description: Tax identification number
        notes:
          type: string
          description: Additional notes
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateCompanyRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: Company name
        address:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
        website:
          type: string
          format: uri
        tax_id:
          type: string
        notes:
          type: string

    UpdateCompanyRequest:
      type: object
      properties:
        name:
          type: string
        address:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
        website:
          type: string
          format: uri
        tax_id:
          type: string
        notes:
          type: string

    CompanyListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Company'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    Receiver:
      type: object
      properties:
        id:
          type: integer
          description: Receiver ID
        user_id:
          type: string
          description: Owner user ID
        name:
          type: string
          description: Receiver name
        is_organization:
          type: boolean
          description: Whether the receiver is an organization
          default: false
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateReceiverRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: Receiver name
        is_organization:
          type: boolean
          description: Whether the receiver is an organization
          default: false

    UpdateReceiverRequest:
      type: object
      properties:
        name:
          type: string
          description: Receiver name
        is_organization:
          type: boolean
          description: Whether the receiver is an organization

    ReceiverListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Receiver'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    MergeReceiversRequest:
      type: object
      required:
        - target_id
        - source_ids
      properties:
        target_id:
          type: integer
          description: ID of the receiver to keep (all invoices will be moved to this receiver)
        source_ids:
          type: array
          items:
            type: integer
          description: IDs of receivers to merge into the target (these receivers will be deleted)
          minItems: 1

    MergeReceiversResult:
      type: object
      properties:
        receiver:
          $ref: '#/components/schemas/Receiver'
        merged_count:
          type: integer
          description: Number of receivers merged
        invoices_updated:
          type: integer
          description: Number of invoices reassigned to the target receiver

    Tag:
      type: object
      properties:
        id:
          type: integer
          description: Tag ID
        user_id:
          type: string
          description: Owner user ID
        name:
          type: string
          description: Tag name
        color:
          type: string
          description: Hex color code (e.g., #FF5733)
          pattern: '^#[0-9A-Fa-f]{6}$'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    InvoiceTagReference:
      type: object
      description: Minimal tag reference included in invoice responses
      required:
        - id
        - name
      properties:
        id:
          type: integer
          description: Tag ID
        name:
          type: string
          description: Tag name

    CreateTagRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: Tag name
        color:
          type: string
          description: Hex color code (e.g., #FF5733)
          pattern: '^#[0-9A-Fa-f]{6}$'

    UpdateTagRequest:
      type: object
      properties:
        name:
          type: string
          description: Tag name
        color:
          type: string
          description: Hex color code (e.g., #FF5733)
          pattern: '^#[0-9A-Fa-f]{6}$'

    TagListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Tag'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    InvoiceStatus:
      type: string
      enum:
        - paid
        - unpaid
        - overdue

    InvoiceItem:
      type: object
      properties:
        id:
          type: integer
          description: Item ID
        invoice_id:
          type: integer
          description: Parent invoice ID
        description:
          type: string
          description: Item description
        quantity:
          type: number
          format: double
          description: Quantity
        unit_price:
          type: number
          format: double
          description: Unit price
        amount:
          type: number
          format: double
          description: Total amount (quantity * unit_price)
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Invoice:
      type: object
      properties:
        id:
          type: integer
          description: Invoice ID
        user_id:
          type: string
          description: Owner user ID
        title:
          type: string
          description: Invoice title
        description:
          type: string
          description: Invoice description
        invoice_started_at:
          type: string
          format: date-time
          description: Billing cycle start date
        invoice_ended_at:
          type: string
          format: date-time
          description: Billing cycle end date
        amount:
          type: number
          format: double
          description: Total amount (calculated from invoice items, read-only)
        currency:
          type: string
          description: Currency code (e.g., USD)
          default: USD
        category_id:
          type: integer
          description: Category ID
        category:
          $ref: '#/components/schemas/Category'
        company_id:
          type: integer
          description: Company ID
        company:
          $ref: '#/components/schemas/Company'
        receiver_id:
          type: integer
          description: Receiver ID
        receiver:
          $ref: '#/components/schemas/Receiver'
        items:
          type: array
          items:
            $ref: '#/components/schemas/InvoiceItem'
        original_download_link:
          type: string
          format: uri
          description: Original invoice file URL
        tags:
          type: array
          items:
            $ref: '#/components/schemas/InvoiceTagReference'
          description: Tags for categorization
        status:
          $ref: '#/components/schemas/InvoiceStatus'
        due_date:
          type: string
          format: date-time
          description: Payment due date
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateInvoiceRequest:
      type: object
      description: Request body for creating an invoice. Note that amount is calculated from invoice items and cannot be set directly.
      required:
        - title
      properties:
        title:
          type: string
          description: Invoice title
        description:
          type: string
        invoice_started_at:
          type: string
          format: date-time
        invoice_ended_at:
          type: string
          format: date-time
        currency:
          type: string
          default: USD
        category_id:
          type: integer
        company_id:
          type: integer
        receiver_id:
          type: integer
        original_download_link:
          type: string
          format: uri
        tag_ids:
          type: array
          items:
            type: integer
          description: Tag IDs to associate with the invoice
        status:
          $ref: '#/components/schemas/InvoiceStatus'
        due_date:
          type: string
          format: date-time
        items:
          type: array
          items:
            $ref: '#/components/schemas/CreateItemRequest'

    CreateItemRequest:
      type: object
      required:
        - description
      properties:
        description:
          type: string
          description: Item description
        quantity:
          type: number
          format: double
          default: 1
        unit_price:
          type: number
          format: double
          default: 0

    UpdateInvoiceRequest:
      type: object
      description: Request body for updating an invoice. Note that amount is calculated from invoice items and cannot be set directly.
      properties:
        title:
          type: string
        description:
          type: string
        invoice_started_at:
          type: string
          format: date-time
        invoice_ended_at:
          type: string
          format: date-time
        currency:
          type: string
        category_id:
          type: integer
        company_id:
          type: integer
        receiver_id:
          type: integer
        original_download_link:
          type: string
          format: uri
        tag_ids:
          type: array
          items:
            type: integer
          description: Tag IDs to associate with the invoice
        status:
          $ref: '#/components/schemas/InvoiceStatus'
        due_date:
          type: string
          format: date-time

    UpdateStatusRequest:
      type: object
      required:
        - status
      properties:
        status:
          $ref: '#/components/schemas/InvoiceStatus'

    AddItemRequest:
      type: object
      required:
        - description
      properties:
        description:
          type: string
          description: Item description
        quantity:
          type: number
          format: double
          default: 1
        unit_price:
          type: number
          format: double
          default: 0

    UpdateItemRequest:
      type: object
      properties:
        description:
          type: string
        quantity:
          type: number
          format: double
        unit_price:
          type: number
          format: double

    InvoiceListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Invoice'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    HtmlToPdfRequest:
      type: object
      required:
        - html
      properties:
        html:
          type: string
          description: HTML content to convert to PDF
        filename:
          type: string
          description: Output filename, defaults to generated.pdf
        paper_width:
          type: number
          format: double
          description: Paper width in inches, defaults to 8.5
        paper_height:
          type: number
          format: double
          description: Paper height in inches, defaults to 11
        margin_top:
          type: number
          format: double
          description: Top margin in inches, defaults to 0.4
        margin_bottom:
          type: number
          format: double
          description: Bottom margin in inches, defaults to 0.4
        margin_left:
          type: number
          format: double
          description: Left margin in inches, defaults to 0.4
        margin_right:
          type: number
          format: double
          description: Right margin in inches, defaults to 0.4
        landscape:
          type: boolean
          description: Landscape orientation, defaults to false

    UploadResponse:
      type: object
      required:
        - key
        - download_url
        - filename
        - size
        - content_type
      properties:
        key:
          type: string
          description: S3 object key
        download_url:
          type: string
          format: uri
          description: Presigned download URL (expires in 1 hour). For a fresh URL after expiration, use GET /api/files/{key}/download
        filename:
          type: string
          description: Original filename
        size:
          type: integer
          description: File size in bytes
        content_type:
          type: string
          description: MIME type

    PresignedURLResponse:
      type: object
      properties:
        upload_url:
          type: string
          format: uri
          description: Presigned URL for upload
        key:
          type: string
          description: S3 object key
        content_type:
          type: string
          description: MIME type

    FileDownloadURLResponse:
      type: object
      properties:
        download_url:
          type: string
          format: uri
          description: Presigned download URL (expires in 1 hour)
        key:
          type: string
          description: S3 object key
        filename:
          type: string
          description: Original filename
        expires_at:
          type: string
          format: date-time
          description: URL expiration time

    AnalyticsSummary:
      type: object
      properties:
        period:
          type: string
          description: Time period (7d, 1m, 1y)
        start_date:
          type: string
          format: date-time
        end_date:
          type: string
          format: date-time
        total_amount:
          type: number
          format: double
        paid_amount:
          type: number
          format: double
        unpaid_amount:
          type: number
          format: double
        overdue_amount:
          type: number
          format: double
        invoice_count:
          type: integer
        paid_count:
          type: integer
        unpaid_count:
          type: integer
        overdue_count:
          type: integer

    AnalyticsGroupItem:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        color:
          type: string
          description: Hex color (for categories)
        total_amount:
          type: number
          format: double
        paid_amount:
          type: number
          format: double
        unpaid_amount:
          type: number
          format: double
        invoice_count:
          type: integer

    AnalyticsByGroup:
      type: object
      properties:
        period:
          type: string
        start_date:
          type: string
          format: date-time
        end_date:
          type: string
          format: date-time
        items:
          type: array
          items:
            $ref: '#/components/schemas/AnalyticsGroupItem'
        uncategorized:
          $ref: '#/components/schemas/AnalyticsGroupItem'
          description: Invoices without category/company/receiver

security:
  - BearerAuth: []
  - OAuth2:
      - read:invoices
      - write:invoices
      - read:categories
      - write:categories
      - read:companies
      - write:companies
      - read:receivers
      - write:receivers
